blackMales = { [ 310] = true, [ 311] = true, [ 300] = true, [ 301] = true, [ 302] = true, [ 296] = true, [ 297] = true, [ 268] = true, [ 269] = true, [ 270] = true, [ 271] = true, [ 272] = true, [ 7] = true, [ 14] = true, [ 15] = true, [ 16] = true, [ 17] = true, [ 18] = true, [ 20] = true, [ 21] = true, [ 22] = true, [ 24] = true, [ 25] = true, [ 28] = true, [ 35] = true, [ 36] = true, [ 50] = true, [ 51] = true, [ 66] = true, [ 67] = true, [ 78] = true, [ 79] = true, [ 80] = true, [ 83] = true, [ 84] = true, [ 102] = true, [ 103] = true, [ 104] = true, [ 105] = true, [ 106] = true, [ 107] = true, [ 134] = true, [ 136] = true, [ 142] = true, [ 143] = true, [ 144] = true, [ 156] = true, [ 163] = true, [ 166] = true, [ 168] = true, [ 176] = true, [ 180] = true, [ 182] = true, [ 183] = true, [ 185] = true, [ 220] = true, [ 221] = true, [ 222] = true, [ 249] = true, [ 253] = true, [ 260] = true, [ 262 ] = true }
whiteMales = {[305] = true, [ 306] = true, [307] = true, [ 308] = true, [ 309] = true, [ 312] = true, [ 303] = true, [ 299] = true, [ 291] = true, [ 292] = true, [ 293] = true, [ 294] = true, [ 295] = true, [ 1] = true, [ 2] = true, [ 23] = true, [ 26] = true, [ 27] = true, [ 29] = true, [ 30] = true, [ 32] = true, [ 33] = true, [ 34] = true, [ 35] = true, [ 36] = true, [ 37] = true, [ 38] = true, [ 43] = true, [ 44] = true, [ 45] = true, [ 46] = true, [ 47] = true, [ 48] = true, [ 50] = true, [ 51] = true, [ 52] = true, [ 53] = true, [ 58] = true, [ 59] = true, [ 60] = true, [ 61] = true, [ 62] = true, [ 68] = true, [ 70] = true, [ 72] = true, [ 73] = true, [ 78] = true, [ 81] = true, [ 82] = true, [ 94] = true, [ 95] = true, [ 96] = true, [ 97] = true, [ 98] = true, [ 99] = true, [ 100] = true, [ 101] = true, [ 108] = true, [ 109] = true, [ 110] = true, [ 111] = true, [ 112] = true, [ 113] = true, [ 114] = true, [ 115] = true, [ 116] = true, [ 120] = true, [ 121] = true, [ 122] = true, [ 124] = true, [ 125] = true, [ 126] = true, [ 127] = true, [ 128] = true, [ 132] = true, [ 133] = true, [ 135] = true, [ 137] = true, [ 146] = true, [ 147] = true, [ 153] = true, [ 154] = true, [ 155] = true, [ 158] = true, [ 159] = true, [ 160] = true, [ 161] = true, [ 162] = true, [ 164] = true, [ 165] = true, [ 170] = true, [ 171] = true, [ 173] = true, [ 174] = true, [ 175] = true, [ 177] = true, [ 179] = true, [ 181] = true, [ 184] = true, [ 186] = true, [ 187] = true, [ 188] = true, [ 189] = true, [ 200] = true, [ 202] = true, [ 204] = true, [ 206] = true, [ 209] = true, [ 212] = true, [ 213] = true, [ 217] = true, [ 223] = true, [ 230] = true, [ 234] = true, [ 235] = true, [ 236] = true, [ 240] = true, [ 241] = true, [ 242] = true, [ 247] = true, [ 248] = true, [ 250] = true, [ 252] = true, [ 254] = true, [ 255] = true, [ 258] = true, [ 259] = true, [ 261] = true, [ 264] = true, [ 272 ] = true }
asianMales = {[290] = true, [ 49] = true, [ 57] = true, [ 58] = true, [ 59] = true, [ 60] = true, [ 117] = true, [ 118] = true, [ 120] = true, [ 121] = true, [ 122] = true, [ 123] = true, [ 170] = true, [ 186] = true, [ 187] = true, [ 203] = true, [ 210] = true, [ 227] = true, [ 228] = true, [ 229] = true, [ 294 ] = true }
blackFemales = {[304] = true, [ 298] = true, [ 10] = true, [ 11] = true, [ 12] = true, [ 13] = true, [ 40] = true, [ 41] = true, [ 63] = true, [ 64] = true, [ 69] = true, [ 76] = true, [ 91] = true, [ 139] = true, [ 148] = true, [ 190] = true, [ 195] = true, [ 207] = true, [ 215] = true, [ 218] = true, [ 219] = true, [ 238] = true, [ 243] = true, [ 244] = true, [ 245] = true, [ 256] = true, [ 304 ] = true }
whiteFemales = {[12] = true, [ 31] = true, [ 38] = true, [ 39] = true, [ 40] = true, [ 41] = true, [ 53] = true, [ 54] = true, [ 55] = true, [ 56] = true, [ 64] = true, [ 75] = true, [ 77] = true, [ 85] = true, [ 87] = true, [ 88] = true, [ 89] = true, [ 90] = true, [ 91] = true, [ 92] = true, [ 93] = true, [ 129] = true, [ 130] = true, [ 131] = true, [ 138] = true, [ 140] = true, [ 145] = true, [ 150] = true, [ 151] = true, [ 152] = true, [ 157] = true, [ 172] = true, [ 178] = true, [ 192] = true, [ 193] = true, [ 194] = true, [ 196] = true, [ 197] = true, [ 198] = true, [ 199] = true, [ 201] = true, [ 205] = true, [ 211] = true, [ 214] = true, [ 216] = true, [ 224] = true, [ 225] = true, [ 226] = true, [ 231] = true, [ 232] = true, [ 233] = true, [ 237] = true, [ 243] = true, [ 246] = true, [ 251] = true, [ 257] = true, [ 263] = true, [ 298 ] = true }
asianFemales = {[38] = true, [ 53] = true, [ 54] = true, [ 55] = true, [ 56] = true, [ 88] = true, [ 141] = true, [ 169] = true, [ 178] = true, [ 224] = true, [ 225] = true, [ 226] = true, [ 263 ] = true }local fittingskins = {[0] = {[0] = blackMales, [1] = whiteMales, [2] = asianMales}, [1] = {[0] = blackFemales, [1] = whiteFemales, [2] = asianFemales}}
local badges = getBadges()
local masks = getMasks()

function removeAnimation(player)
	exports.global:removeAnimation(player)
end

function giveHealth(player, health)
	setElementHealth( player, math.min( 100, getElementHealth( player ) + health ) )
end

function removeOOC(text)
	return text:gsub("%s*%(%(([^)]+)%)%)%s*","") -- removes the (( )) part
end

local shields = { }
local presents = { 1, 7, 8, 15, 11, 12, 19, 26, 59, 71 }
local glowstickColor = 1
--
-- callbacks
function useItem(itemSlot, additional)

	if not itemSlot then
		return
	end

	local items = getItems(source)
	local itemID = items[itemSlot][1]
	local itemValue = items[itemSlot][2]
	local itemName = getItemName( itemID, itemValue )
	if isPedDead(source) or getElementData(source, "injuriedanimation") then return end

	local hasItemProtect = hasItem(source, tonumber( itemID ), tostring(itemValue)) or  hasItem(source, tonumber( itemID ), tonumber(itemValue)) 
	if not hasItemProtect then
		return
	end
	
	if itemID then
		if (itemID==1) then -- hotdog
			setElementHealth(source, 100)
			exports.global:sendLocalMeAction(source, "eats a hotdog.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==3) then -- car key
			local veh = getPedOccupiedVehicle(source)
			if veh and getElementData(veh, "dbid") == itemValue then
				triggerEvent("lockUnlockInsideVehicle", source, veh)
			else
				-- unlock nearby cars
				local value = exports.pool:getElement( "vehicle", itemValue )
				if value then
					local vx, vy, vz = getElementPosition(value)
					local x, y, z = getElementPosition(source)
						
					if getDistanceBetweenPoints3D(x, y, z, vx, vy, vz) <= 30 then -- car found
						triggerEvent("lockUnlockOutsideVehicle", source, value)
					else
						outputChatBox("You are too far from the vehicle.", source, 255, 194, 14)
					end
				else
					outputChatBox("Invalid Vehicle.", source, 255, 194, 14)
				end
			end
		elseif (itemID==4) or (itemID==5) then -- house key or business key
			local itemValue = tonumber(itemValue)
			local found = false
			
			local posX, posY, posZ = getElementPosition(source)
			local dimension = getElementDimension(source)
			local possibleInteriors = getElementsByType("interior")
			for _, interior in ipairs(possibleInteriors) do
				local interiorEntrance = getElementData(interior, "entrance")
				local interiorExit = getElementData(interior, "exit")
				local interiorID = getElementData(interior, "dbid")	
				if interiorID == itemValue then	
					for _, point in ipairs( { interiorEntrance, interiorExit } ) do
						if (point[5] == dimension) then
							local distance = getDistanceBetweenPoints3D(posX, posY, posZ, point[1], point[2], point[3])
							if (distance <= 6) then
								found = interiorID
								break
							end
						end
					end
				end
			end

			if not found then
				local possibleElevators = getElementsByType("elevator")
				for _, elevator in ipairs(possibleElevators) do
					local elevatorEntrance = getElementData(elevator, "entrance")
					local elevatorExit = getElementData(elevator, "exit")
					
					for _, point in ipairs( { elevatorEntrance, elevatorExit } ) do
						if (point[5] == dimension) then
							local distance = getDistanceBetweenPoints3D(pPosX, pPosY, pPosZ, point[1], point[2], point[3])
							if (distance < 6) then
								if elevatorEntrance[5] == itemValue then
									found = elevatorEntrance[5]
									break
								elseif elevatorExit[5] == itemValue  then
									found = elevatorExit[5]
									break
								end
							end
						end
					end
				end
			end
			
			if found then
				local dbid, entrance, exit, interiorType, interiorElement = exports['interior-system']:findProperty( source, found )
				local interiorStatus = getElementData(interiorElement, "status")
				local locked = interiorStatus[3] and 1 or 0

				locked = 1 - locked -- Invert status
				
				
				local newRealLockedValue = false
				mysql:query_free("UPDATE interiors SET locked='" .. locked .. "' WHERE id='" .. found .. "' LIMIT 1") 
				if locked == 0 then
					exports.global:sendLocalMeAction(source, "puts the key in the door to unlock it.")
					if not (exports.global:hasItem(source, 4, found)) and not (exports.global:hasItem(source, 5, found)) then
						exports.logs:logMessage("[INTERIOR-UNLOCK] Interior #" .. found .. " was unlocked by " .. getPlayerName(source), 21)
					end
				else
					newRealLockedValue = true
					exports.global:sendLocalMeAction(source, "puts the key in the door to lock it.")
					
					if not (exports.global:hasItem(source, 4, found)) and not (exports.global:hasItem(source, 5, found)) then
						exports.logs:logMessage("[INTERIOR-LOCK] Interior #" .. found .. " was locked by " .. getPlayerName(source), 21)
					end
				end
				
				interiorStatus[3] = newRealLockedValue
				exports['anticheat-system']:changeProtectedElementDataEx(interiorElement, "status", interiorStatus, true)	
			else
				outputChatBox("You are too far from the door.", source, 255, 194, 14)
			end
		elseif (itemID==73) then -- elevator remote
			local itemValue = tonumber(itemValue)
			local found = nil
			
			local dimension = getElementDimension(source)
			local posX, posY, posZ = getElementPosition(source)
			local possibleElevators = getElementsByType("elevator")
			for _, elevator in ipairs(possibleElevators) do
				local elevatorEntrance = getElementData(elevator, "entrance")
				local elevatorExit = getElementData(elevator, "exit")
				local elevatorID = getElementData(elevator, "dbid")
				if elevatorID == itemValue then
					for _, point in ipairs( { elevatorEntrance, elevatorExit } ) do
						if (point[5] == dimension) then
							local distance = getDistanceBetweenPoints3D(posX, posY, posZ, point[1], point[2], point[3])
							if (distance < 6) then
								found = elevator
								break
							end
						end
					end
				end
			end
			
			if not found then
				outputChatBox("You are too far from the door.", source, 255, 194, 14)
			else
				triggerEvent( "toggleCarTeleportMode", found, source )
			end
		elseif (itemID==8) then -- sandwich
			giveHealth(source, 50)
			exports.global:applyAnimation(source, "food", "eat_burger", 4000, false, true, true)
			toggleAllControls(source, true, true, true)
			triggerClientEvent(source, "onClientPlayerWeaponCheck", source)
			exports.global:sendLocalMeAction(source, "eats a sandwich.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==9) then -- sprunk
			giveHealth(source, 30)
			exports.global:applyAnimation(source, "VENDING", "VEND_Drink_P", 4000, false, true, true)
			toggleAllControls(source, true, true, true)
			triggerClientEvent(source, "onClientPlayerWeaponCheck", source)
			exports.global:sendLocalMeAction(source, "drinks a sprunk.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==10) then -- red dice
			exports.global:sendLocalText(source, " *((Dice)) " .. getPlayerName(source):gsub("_", " ") .. " rolls a dice and gets " .. math.random( 1, 6 ) ..".", 255, 51, 102)
		elseif (itemID==11) then -- taco
			giveHealth(source, 10)
			exports.global:applyAnimation(source, "FOOD", "EAT_Burger", 4000, false, true, true)
			exports.global:sendLocalMeAction(source, "eats a taco.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==12) then -- cheeseburger
			giveHealth(source, 10)
			exports.global:applyAnimation(source, "FOOD", "EAT_Burger", 4000, false, true, true)
			setTimer(removeAnimation, 4000, 1, source)
			exports.global:sendLocalMeAction(source, "eats a cheeseburger.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==13) then -- donut
			setElementHealth(source, 100)
			exports.global:applyAnimation(source, "FOOD", "EAT_Burger", 4000, false, true, true)
			exports.global:sendLocalMeAction(source, "eats a donut.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==14) then -- cookie
			giveHealth(source, 80)
			exports.global:applyAnimation(source, "FOOD", "EAT_Burger", 4000, false, true, true)
			exports.global:sendLocalMeAction(source, "eats a cookie.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==15) then -- water
			giveHealth(source, 90)
			exports.global:applyAnimation(source, "VENDING", "VEND_Drink_P", 4000, false, true, true)
			exports.global:sendLocalMeAction(source, "drinks a bottle of water.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==16) then -- clothes
			local result = mysql:query_fetch_assoc("SELECT gender,skincolor FROM characters WHERE id='" .. getElementData(source, "dbid") .. "' LIMIT 1")
			local gender = tonumber(result["gender"])
			local race = tonumber(result["skincolor"])
			
			local skin = tonumber(itemValue)
			if fittingskins[gender] and fittingskins[gender][race] and fittingskins[gender][race][skin] then
				local vehicle, veholdstate = getPedOccupiedVehicle ( source ), nil
				if vehicle then
					veholdstate = getVehicleEngineState ( vehicle )
				end
				setElementModel(source, skin)
				mysql:query_free( "UPDATE characters SET skin = " .. skin .. " WHERE id = " .. getElementData( source, "dbid" ) )
				if exports['anticheat-system']:changeProtectedElementDataEx(source, "casualskin", skin, false) then
					mysql:query_free("UPDATE characters SET casualskin = " .. skin .. " WHERE id = " .. getElementData(source, "dbid") )
				end
				exports.global:sendLocalMeAction(source, "changes their clothes.")
				if vehicle then
					setTimer(setVehicleEngineState, 200, 1, vehicle, veholdstate)
				end
			else
				outputChatBox("These clothes do not fit you.", source, 255, 0, 0)
			end
		elseif (itemID==17) then -- watch
			exports.global:sendLocalMeAction(source, "looks at their watch.")
			outputChatBox("The time is " .. string.format("%02d:%02d", getTime()) .. ".", source, 255, 194, 14)
			exports.global:applyAnimation(source, "COP_AMBIENT", "Coplook_watch", 4000, false, true, true)
		elseif (itemID==20) then -- STANDARD FIGHTING
			setPedFightingStyle(source, 4)
			outputChatBox("You read a book on how to do Standard Fighting.", source, 255, 194, 14)
			mysql:query_free("UPDATE characters SET fightstyle = 4 WHERE id = " .. getElementData( source, "dbid" ) )
		elseif (itemID==21) then -- BOXING
			setPedFightingStyle(source, 5)
			outputChatBox("You read a book on how to do Boxing.", source, 255, 194, 14)
			mysql:query_free("UPDATE characters SET fightstyle = 5 WHERE id = " .. getElementData( source, "dbid" ) )
		elseif (itemID==22) then -- KUNG FU
			setPedFightingStyle(source, 6)
			outputChatBox("You read a book on how to do Kung Fu.", source, 255, 194, 14)
			mysql:query_free("UPDATE characters SET fightstyle = 6 WHERE id = " .. getElementData( source, "dbid" ) )
		elseif (itemID==23) then -- KNEE HEAD
			--setPedFightingStyle(source, 7)
			outputChatBox("You open the book, and notice that the book is written in old greek.", source, 255, 194, 14)
			--mysql:query_free("UPDATE characters SET fightstyle = 7 WHERE id = " .. getElementData( source, "dbid" ) )
		elseif (itemID==24) then -- GRAB KICK
			setPedFightingStyle(source, 15)
			outputChatBox("You read a book on how to do Grab Kick Fighting.", source, 255, 194, 14)
			mysql:query_free( "UPDATE characters SET fightstyle = 15 WHERE id = " .. getElementData( source, "dbid" ) )
		elseif (itemID==25) then -- ELBOWS
			setPedFightingStyle(source, 16)
			outputChatBox("You read a book on how to do Elbow Fighting.", source, 255, 194, 14)
			mysql:query_free("UPDATE characters SET fightstyle = 16 WHERE id = " .. getElementData( source, "dbid" ) )
		elseif (itemID==27) then -- FLASHBANG
			takeItemFromSlot(source, itemSlot)
			
			local obj = createObject(343, unpack(additional))
			exports.pool:allocateElement(obj)
			setTimer(explodeFlash, math.random(400, 800), 1, obj)
			exports.global:sendLocalMeAction(source, "throws a flashbang.")
			setElementInterior(obj, getElementInterior(source))
			setElementDimension(obj, getElementDimension(source))
		elseif (itemID==28) then -- GLOWSTICK
			takeItemFromSlot(source, itemSlot)
		
			local x, y, groundz = unpack(additional)
			local marker = nil
			if tostring(itemValue) == "2" then
				marker = createMarker(x, y, groundz, "corona", 1, 255, 0, 0, 150)
			elseif tostring(itemValue) == "3" then
				marker = createMarker(x, y, groundz, "corona", 1, 0, 255, 0, 150)
			elseif tostring(itemValue) == "4" then
				marker = createMarker(x, y, groundz, "corona", 1, 255, 255, 0, 150)
			elseif tostring(itemValue) == "5" then
				marker = createMarker(x, y, groundz, "corona", 1, 255, 0, 255, 150)
			elseif tostring(itemValue) == "6" then
				marker = createMarker(x, y, groundz, "corona", 1, 0, 255, 255, 150)
			elseif tostring(itemValue) == "7" then
				marker = createMarker(x, y, groundz, "corona", 1, 255, 255, 255, 150)
			else
				marker = createMarker(x, y, groundz, "corona", 1, 0, 0, 255, 150)
			end
			exports.pool:allocateElement(marker)
			exports.global:sendLocalMeAction(source, "drops a glowstick.")
			setTimer(destroyElement, 600000, 1, marker)
		elseif (itemID==29) then -- RAM
			if (getElementData(source, "duty") > 0) and (getElementModel(source) == 285) then
				local found = false
				local lastDistance = 5
				local posX, posY, posZ = getElementPosition(source)
				local dimension = getElementDimension(source)
				local possibleInteriors = getElementsByType("interior")
				for _, interior in ipairs(possibleInteriors) do
					local interiorEntrance = getElementData(interior, "entrance")
					local interiorExit = getElementData(interior, "exit")
					
					for _, point in ipairs( { interiorEntrance, interiorExit } ) do
						if (point[5] == dimension) then
							local distance = getDistanceBetweenPoints3D(posX, posY, posZ, point[1], point[2], point[3])
							if (distance < lastDistance) then
								found = interior
								lastDistance = distance
							end
						end
					end
				end

				if not (found) then
					outputChatBox("You are not near a door.", source, 255, 194, 14)
				else
					local dbid = getElementData(found, "dbid")
					local interiorStatus = getElementData(found, "status")
					
					if (interiorStatus[1] ~= 2) and (interiorStatus[4] < 0) and (interiorStatus[3]) and not (interiorStatus[2]) then
						outputChatBox("That door is not owned by a player.", source, 255, 0, 0)
					elseif interiorStatus[2] then
						outputChatBox("That door is disabled.", source, 255, 0, 0)
					elseif (interiorStatus[3]) then
						interiorStatus[3] = false
						exports['anticheat-system']:changeProtectedElementDataEx(found, "status", interiorStatus, true)
						mysql:query_free("UPDATE interiors SET locked='0' WHERE id='" .. mysql:escape_string(dbid) .. "' LIMIT 1") 
						exports.global:sendLocalMeAction(source, "swings the ram into the door, opening it.")
						exports.global:sendMessageToAdmins("Player "..getPlayerName(source).." opened interior "..dbid.." with a doorram")
						exports.logs:dbLog(source, 31, { source, found }, "UNLOCK WITH DOORRAM")
					else
						outputChatBox("That door is not locked.", source, 255, 0, 0)
					end
				end
			else
				outputChatBox("You are not on SWAT duty.", source, 255, 0, 0)
			end
		elseif (itemID>=34 and itemID<=44) then -- DRUGS
			takeItemFromSlot(source, itemSlot)
			
			if getPedOccupiedVehicle(source) and ( itemID == 38 or itemID == 42 ) then
				outputChatBox("You take some " .. itemName .. ", but nothing happens...", source, 255, 0, 0)
			else
				exports.global:sendLocalMeAction(source, "takes some " .. itemName .. ".")
			end
		elseif (itemID==49) then
			triggerEvent( "fish", source )
		elseif (itemID==50) then -- highway code book
			local bookTitle = "The Los Santos Highway Code"
			local bookName = "LSHighwayCode"
			exports.global:sendLocalMeAction(source, "reads ".. bookTitle ..".")
			triggerClientEvent( source, "showBook", source, bookName, bookTitle )
		elseif (itemID==51) then -- chemistry book
			local bookTitle = "Chemistry 101"
			local bookName = "Chemistry101"
			exports.global:sendLocalMeAction(source, "reads ".. bookTitle ..".")
			triggerClientEvent( source, "showBook", source, bookName, bookTitle )
		elseif (itemID==52) then -- PD manual book
			local bookTitle = "The Police Officer's Manual"
			local bookName = "PDmanual"
			exports.global:sendLocalMeAction(source, "reads ".. bookTitle ..".")
			triggerClientEvent( source, "showBook", source, bookName, bookTitle )
		elseif (itemID==54) then -- GHETTOBLASTER
			exports.global:sendLocalMeAction(source, "places a ghettoblaster on the ground.")
			local x, y, z = unpack(additional)
			
			triggerEvent("dropItem", source, itemSlot, x, y, z+0.3)
		elseif (itemID==55) then -- Stevie's business card
			exports.global:sendLocalMeAction(source, "looks at a piece of paper.")
			outputChatBox("The card reads: 'Steven Pullman - L.V. Freight Depot, Tel: 12555'", source, 255, 51, 102)
		elseif (itemID==57) then -- FUEL CAN
			local nearbyVehicles = exports.global:getNearbyElements(source, "vehicle")
			
			if #nearbyVehicles < 1 then return end
			
			local found = nil
			local shortest = 6
			local x, y, z = getElementPosition(source)
			for i, veh in ipairs(nearbyVehicles) do
				local distanceToVehicle = getDistanceBetweenPoints3D(x, y, z, getElementPosition(veh))
				if shortest > distanceToVehicle then
					shortest = distanceToVehicle
					found = veh
				end
			end
			
			if found then
				triggerEvent("fillFuelTankVehicle", source, found, itemValue)
			else
				outputChatBox("You are too far from a vehicle.", source, 255, 194, 14)
			end
		elseif (itemID==58) then
			takeItemFromSlot(source, itemSlot)
			exports.global:sendLocalMeAction(source, "drinks some good Ziebrand Beer.")
			setElementHealth(source,getElementHealth(source)-5)
		elseif (itemID==59) then -- MUDKIP
			takeItemFromSlot(source, itemSlot)
			exports.global:sendLocalMeAction(source, "eats a mudkip.")
			--killPed(source)
		elseif (itemID==60) then
			local x,y,z = getElementPosition(source)
			local rz = getPedRotation(source)
			local dimension = getElementDimension(source)
			local retval = call(getResourceFromName("interior-system"), "addSafeAtPosition", source, x,y,z, rz) --0 no error, 1 safe already exists, 2 player does not own interior
			if (retval == 0) then
				exports.global:sendLocalMeAction(source, "Places a safe.")
				takeItemFromSlot(source, itemSlot)
			elseif (retval == 2) then
				outputChatBox("You are not inside an interior.", source, 255, 0, 0)
			elseif (retval == 3) then
				outputChatBox("You need to own the interior you are placing the safe in!", source, 255, 0, 0)
			end
		elseif (itemID==62) then
			takeItemFromSlot(source, itemSlot)
			exports.global:sendLocalMeAction(source, "drinks some pure Bastradov Vodka.")
			setElementHealth(source,getElementHealth(source)-10)
		elseif (itemID==63) then
			takeItemFromSlot(source, itemSlot)
			exports.global:sendLocalMeAction(source, "drinks some Scottish Whiskey.")
			setElementHealth(source,getElementHealth(source)-10)
		elseif (itemID==69) then -- Dictionary
			local learned = call(getResourceFromName("language-system"), "learnLanguage", source, itemValue, true)
			local lang = call(getResourceFromName("language-system"), "getLanguageName", itemValue)
			
			if (learned) then
				takeItem(source, itemID, itemValue)
				outputChatBox("You have learnt basic " .. lang .. ", Press F6 to manage your languages.", source, 0, 255, 0)
			end
		elseif (itemID==72) then -- Note
			exports.global:sendLocalMeAction(source, "reads a note.")
		--[=[ REMOVED :> mabako, 11th January 2012 (plus it'd be broken, /lazy)
		elseif (itemID==74) then
			takeItemFromSlot(source, itemSlot)
			local x, y, z = getElementPosition(source)
			createExplosion( x, y, z, 10, source )
			createExplosion( x, y, z, 10, source )
		elseif (itemID==75) then
			exports.global:sendLocalMeAction(source, "pushes some kind of red button which reads 'do not push'.")
			local px, py, pz = getElementPosition(source)
			for k, v in pairs( getElementsByType( "object", getResourceRootElement( ) ) ) do
				if isElement( v ) and getElementData( v, "itemID" ) == 74 and getElementData( v, "itemValue" ) == itemValue then
					local x, y, z = getElementPosition( v )
					if getDistanceBetweenPoints3D( x, y, z, px, py, pz ) < 200 then
						mysql:query_free("DELETE FROM worlditems WHERE id = " .. getElementData( v, "id" ) )
						createExplosion( x, y, z, 10, source )
						createExplosion( x, y, z, 10, source )
						destroyElement( v )
					end
				end
			end
			
			for k, v in pairs( exports.global:getNearbyElements(source, "vehicle", 200) ) do
				if hasItem( v, 74, itemValue ) then
					blowVehicle( v )
					
					while hasItem( v, 74 ) do
						takeItem( v, 74 )
					end
				end
			end
			
			for k, v in pairs( exports.global:getNearbyElements(source, "player", 200) ) do
				if hasItem( v, 74, itemValue ) then
					local x, y, z = getElementPosition( v )
					createExplosion( x, y, z, 10, source )
					createExplosion( x, y, z, 10, source )
					
					while hasItem( v, 74 ) do
						takeItem( v, 74 )
					end
				end
			end
		]=]
		elseif (itemID==76) then -- SHIELD
			if (shields[source]) then -- Already using the shield
				destroyElement(shields[source])
				shields[source] = nil
			else
				local x, y, z = getElementPosition(source)
				local rot = getPedRotation(source)
				
				x = x + math.sin(math.rad(rot)) * 1.5
				y = y + math.cos(math.rad(rot)) * 1.5
				
				local object = createObject(1631, x, y, z)
				attachElements(object, source, 0, 1, 0)
				shields[source] = object
			end
		elseif (itemID==77) then -- Card Deck
			local cards = { "Ace", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine", "Ten", "Jack", "Queen", "King" }
			local sign = { "Spades", "Clubs", "Hearts", "Diamonds" }
			local number = math.random( 1, #cards )
			local snumber = math.random( 1, #sign )
			exports.global:sendLocalText(source, " *((Cards)) " .. getPlayerName(source):gsub("_", " ") .. " draws a card and gets a" .. ( number == 1 and "n" or "" ) .. " " .. cards[number] .." of ".. sign[snumber] ..".", 255, 51, 102)
		elseif (itemID==79) then -- Porn tape
			exports.global:applyAnimation( source, "PAULNMAC", "wank_loop", -1, true, false, false)
		elseif (itemID==80) then -- Generic Item
			showItem(itemName)
		elseif (itemID==83) then -- Coffee
			giveHealth(source, 40)
			exports.global:applyAnimation(source, "VENDING", "VEND_Drink_P", 4000, false, true, true)
			exports.global:sendLocalMeAction(source, "drinks a cup of coffee.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==88) then -- earpiece
			outputChatBox("You can use this earpiece with an radio.", source, 255, 194, 14)
		elseif (itemID==89) then -- Generic Food
			giveHealth(source, tonumber(getItemValue(itemID, itemValue)))
			exports.global:applyAnimation(source, "food", "eat_burger", 4000, false, true, true)
			exports.global:sendLocalMeAction(source, "eats a " .. itemName .. ".")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==91) then
			takeItemFromSlot(source, itemSlot)
			exports.global:sendLocalMeAction(source, "drinks some good Eggnog.")
			setElementHealth(source, 100)
		elseif (itemID==92) then
			setElementHealth(source, 100)
			exports.global:applyAnimation(source, "FOOD", "EAT_Burger", 4000, false, true, true)
			exports.global:sendLocalMeAction(source, "eats some Turkey.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==93) then
			setElementHealth(source, 100)
			exports.global:applyAnimation(source, "FOOD", "EAT_Burger", 4000, false, true, true)
			exports.global:sendLocalMeAction(source, "eats some Christmas Pudding.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==94) then

			local id = math.random(1, 10)
			local prizeID = presents[id]
			takeItemFromSlot(source, itemSlot)
			giveItem(source, prizeID, 1)
			exports.global:sendLocalMeAction(source, "opens a Christmas Present")
		elseif (itemID==95) then -- Generic Drink
			giveHealth(source, tonumber(getItemValue(itemID, itemValue)))
			exports.global:applyAnimation(source, "VENDING", "VEND_Drink_P", 4000, false, true, true)
			exports.global:sendLocalMeAction(source, "drinks some " .. itemName .. ".")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==96) then -- PDA
			exports.global:sendLocalMeAction(source, "turns their " .. ( itemValue == 1 and "PDA" or itemValue ) .. " on.")
			triggerClientEvent(source, "useCompItem", source)
		elseif (itemID==97) then -- LSES Procedures Manual (book)
			local bookTitle = "LSES Procedure Manual"
			local bookName = "LSESProcedureManual"
			exports.global:sendLocalMeAction(source, "reads ".. bookTitle ..".")
			triggerClientEvent( source, "showBook", source, bookName, bookTitle )
		elseif (itemID==98) then -- Garage Remote
			local id = tonumber( itemValue )
			if id and id >= 0 and id <= 49 then
				setGarageOpen(itemValue, not isGarageOpen(itemValue))
				
				local garages = {}
				for i = 0, 49 do
					garages[i] = isGarageOpen(i)
				end
				mysql:query_free("UPDATE settings SET value = '" .. mysql:escape_string( toJSON( garages ) ) .. "' WHERE name = 'garagestates'" )
			end
		elseif (itemID==99) then --[ADDED: 2/22/10 by herbjr] tray
			giveHealth(source, 50)
			exports.global:applyAnimation(source, "food", "eat_burger", 4000, false, true, true)
			toggleAllControls(source, true, true, true)
			triggerClientEvent(source, "onClientPlayerWeaponCheck", source)
			exports.global:sendLocalMeAction(source, "eats the food from the tray.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==100) then --[ADDED: 2/22/10 by herbjr] milk
			giveHealth(source, 30)
			exports.global:applyAnimation(source, "VENDING", "VEND_Drink_P", 4000, false, true, true)
			toggleAllControls(source, true, true, true)
			triggerClientEvent(source, "onClientPlayerWeaponCheck", source)
			exports.global:sendLocalMeAction(source, "drinks a small carton of milk.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==101) then --[ADDED: 2/22/10 by herbjr] juice
			giveHealth(source, 30)
			exports.global:applyAnimation(source, "VENDING", "VEND_Drink_P", 4000, false, true, true)
			toggleAllControls(source, true, true, true)
			triggerClientEvent(source, "onClientPlayerWeaponCheck", source)
			exports.global:sendLocalMeAction(source, "drinks a small carton of juice.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==102) then --[ADDED: 2/23/10 by herbjr] Cabbage (Asked for by Misha)
			giveHealth(source, 15)
			exports.global:applyAnimation(source, "food", "eat_burger", 4000, false, true, true)
			toggleAllControls(source, true, true, true)
			triggerClientEvent(source, "onClientPlayerWeaponCheck", source)
			exports.global:sendLocalMeAction(source, "eats a head of Cabbage.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==104) then -- portable TV
			triggerEvent("useTV", source, source)
			local isTvUsed = getElementData(source, "isTvUsed")
			if isTvUsed == nil or isTvUsed == false then
				exports.global:sendLocalMeAction(source, "turns on a small portable TV.")
				exports['anticheat-system']:changeProtectedElementDataEx(source, "isTvUsed", true, false)
			else
				exports['anticheat-system']:changeProtectedElementDataEx(source, "isTvUsed", false, false)
			end
		elseif (itemID == 105) then -- Pack of cigarettes. Withdraw one if it still has one
			if (itemValue > 0) then
				if (hasSpaceForItem(source, 106, 1)) then
					takeItemFromSlot(source, itemSlot)
					giveItem(source, itemID, itemValue - 1) 
					giveItem(source, 106, 1) 
					exports.global:sendLocalMeAction(source, "looks inside their pack of cigarettes, and takes one out.")
				else
					outputChatBox( "Your Inventory is full.", source, 255, 0, 0 )
				end
			else
				exports.global:sendLocalMeAction(source, "looks inside their pack of cigarettes. It's empty.")
			end
		elseif (itemID == 106) then -- Cigarette
			if hasItem( source, 107 ) then
				exports.global:sendLocalMeAction(source, "lights up a cigarette.")
				outputChatBox( "(( /throwaway to throw it away, /switchhand to change hand ))", source )
				triggerEvent("realism:startsmoking", source, 0) -- 0 = left hand -- 1 = right hand
				takeItemFromSlot(source, itemSlot)
			else
				exports.global:sendLocalMeAction(source, "shows everyone a cigarette.")
				outputChatBox( "You'll need a lighter to use it properly, tho.", source, 255, 0, 0 )
			end
		elseif (itemID == 107) then
			exports.global:sendLocalMeAction(source, "shows everyone a lighter.")
		elseif (itemID==108) then -- donut
			setElementHealth(source, 100)
			exports.global:applyAnimation(source, "FOOD", "EAT_Burger", 4000, false, true, true)
			exports.global:sendLocalMeAction(source, "eats a pancake.")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID==109) or (itemID==110) then -- Fruit
			giveHealth(source, tonumber(getItemValue(itemID, itemValue)))
			exports.global:applyAnimation(source, "food", "eat_burger", 4000, false, true, true)
			exports.global:sendLocalMeAction(source, "eats a " .. itemName .. ".")
			takeItemFromSlot(source, itemSlot)
		elseif (itemID == 113) then -- Pack of glowsticks, Withdraw one if it still has one
			if (itemValue > 0) then
				if (hasSpaceForItem(source, 28, 1)) then
					glowStickColour = 1 + ( ( glowStickColour or 0 ) + 1 ) % 7
					
					takeItemFromSlot(source, itemSlot)
					giveItem(source, itemID, itemValue - 1) 
					giveItem(source, 28, glowStickColour) 
					exports.global:sendLocalMeAction(source, "looks inside their pack of glowsticks, sliding one out.")
				else
					outputChatBox( "Your Inventory is full.", source, 255, 0, 0 )
				end
			else
				exports.global:sendLocalMeAction(source, "looks inside their pack of glowsticks. It's empty.")
			end
		elseif itemID == 114 then
			local vehicle = getPedOccupiedVehicle(source)
			local noUpgrades = { Boat = true, Helicopter = true, Plane = true, Train = true, BMX = true }

			if vehicle and not noUpgrades[getVehicleType(vehicle)] and getElementDimension(vehicle) > 0 and getItemDescription(itemID, itemValue) ~= "?" then
				addUpgrade( source, vehicle, itemSlot, itemID, itemValue )
			else
				outputChatBox("Use this in a vehicle & garage to add it as permanent upgrade.", source, 255, 194, 14)
			end
		elseif badges[itemID] then
			if ( getElementData( source, badges[itemID][1] ) ) then
				exports['anticheat-system']:changeProtectedElementDataEx(source, badges[itemID][1], false, true)
				exports.global:sendLocalMeAction(source, "removes " .. badges[itemID][2] .. ".")
			else
				for key, badge in pairs ( badges ) do
					if key ~= itemID then
						if ( getElementData ( source, badge[1] ) ) then
							exports['anticheat-system']:changeProtectedElementDataEx( source, badge[1], false, true )
							exports.global:sendLocalMeAction( source, "removes " .. badge[2] .. "." )
						end
					end
				end
				
				exports['anticheat-system']:changeProtectedElementDataEx( source, badges[itemID][1], removeOOC(itemValue), true )
				exports.global:sendLocalMeAction( source, "puts on " .. badges[itemID][2] .. "." )
			end
			exports.global:updateNametagColor(source)
		elseif masks[itemID] then
			local data = masks[itemID]
			local mask = getElementData(source, data[1])
			
			if mask then
				exports.global:sendLocalMeAction(source, data[3] .. ".")
				exports['anticheat-system']:changeProtectedElementDataEx(source, data[1], false, true)
			elseif getPedOccupiedVehicle(source) and getElementData(getPedOccupiedVehicle(source), "job") > 0 and getVehicleOccupant(getPedOccupiedVehicle(source)) == source then
				outputChatBox("You can't use this in a Civilian vehicle.", source, 255, 0, 0)
			else
				exports.global:sendLocalMeAction(source, data[2] ..".")
				exports['anticheat-system']:changeProtectedElementDataEx(source, data[1], true, true)
			end
		else
			outputChatBox("Error J" .. ("%04d"):format(tonumber(itemID) or 9999) .. " - Report on http://bugs.mta.vg", source, 255, 0, 0)
		end
	end
end
addEvent("useItem", true)
addEventHandler("useItem", getRootElement(), useItem)
addCommandHandler("useitem",
	function(thePlayer, commandName, itemID, ...)
		if tonumber( itemID ) then
			local args = {...}
			local itemValue
			if #args > 0 then
				itemValue = table.concat(args, " ")
				itemValue = tonumber(itemValue) or itemValue
			end
			
			local has, slot = hasItem(thePlayer, tonumber( itemID ), itemValue)
			if has then
				triggerEvent("useItem", thePlayer, slot)
			end
		end
	end
)

function explodeFlash(obj)
	local players = exports.global:getNearbyElements(obj, "player")
	
	destroyElement(obj)
	for key, value in ipairs(players) do
		local gasmask = getElementData(value, "gasmask")
		
		if not (gasmask) then
			playSoundFrontEnd(value, 47)
			fadeCamera(value, false, 0.5, 255, 255, 255)
			setTimer(cancelEffect, 5000, 1, value)
			setTimer(playSoundFrontEnd, 1000, 1, value, 48)
		end
	end
end

function cancelEffect(thePlayer)
	fadeCamera(thePlayer, true, 6.0)
end

tags = {1524, 1525, 1526, 1527, 1528, 1529, 1530, 1531 }

function destroyGlowStick(marker)
	destroyElement(marker)
end

function destroyItem(itemID)
	if isPedDead(source) or getElementData(source, "injuriedanimation") then return end
	local itemName = ""
	if itemID and itemID > 0 then
		local itemSlot = itemID
		local item = getItems( source )[itemSlot]
		if item then
			local itemID = item[1]
			local itemValue = item[2]
			
			if itemID == 48 and countItems( source, 48 ) == 1 then -- backpack
				if getCarriedWeight( source ) - getItemWeight( 48, 1 ) > 10 then
					return
				end
			end
			
			itemName = getItemName( itemID, itemValue )
			takeItemFromSlot(source, itemSlot)
			
			triggerClientEvent(source, "item:updateclient", source)
			
			doItemGiveawayChecks(source, itemID)
		else
			return
		end
	else
		if itemID == -100 then
			setPedArmor(source, 0)
			itemName = "Body Armor"
		else
			exports.global:takeWeapon(source, tonumber(-itemID))
			itemName = getWeaponNameFromID( -itemID )
		end
	end
	outputChatBox("You destroyed a " .. itemName .. ".", source, 255, 194, 14)
	exports.global:sendLocalText(source, " ** " .. getPlayerName(source):gsub("_", " ") .. " destroyed a " .. itemName .. ".", 255, 51, 102) 
end
addEvent("destroyItem", true)
addEventHandler("destroyItem", getRootElement(), destroyItem)

function showItem(itemName)
	if isPedDead(source) or getElementData(source, "injuriedanimation") then return end
	exports.global:sendLocalMeAction(source, "shows everyone a " .. itemName .. ".")
end
addEvent("showItem", true)
addEventHandler("showItem", getRootElement(), showItem)

function resetAnim(thePlayer)
	exports.global:removeAnimation(thePlayer)
end

function showInventoryRemote(thePlayer, commandName, targetPlayer)
	if exports.global:isPlayerAdmin(thePlayer) then
		if not (targetPlayer) then
			outputChatBox("SYNTAX: /" .. commandName .. " [Player Partial Nick / ID]", thePlayer, 255, 194, 14)
		else
			local targetPlayer = exports.global:findPlayerByPartialNick(thePlayer, targetPlayer)
			if targetPlayer then
				triggerEvent("subscribeToInventoryChanges",thePlayer,targetPlayer)
				triggerClientEvent(thePlayer,"showInventory",thePlayer,targetPlayer)
			end
		end
	end
end
addCommandHandler("showinv", showInventoryRemote, false, false)



--
-- are we watching TV?
--
function isWatchingTV( player )
	return exports['freecam-tv']:isPlayerFreecamEnabled( player )
end
